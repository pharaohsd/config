#!/usr/bin/env ruby
# Author: Gigamo <gigamo@gmail.com>
# Requires scrot, imagemagick and ncftp
require '/home/gig/.passwords.rb' # My FTP pw and username in there

HOME = ENV["HOME"]
FTPHOST = "users.telenet.be"
FTPPATH = "pics"
FTPUSER = FTP_USER
FTPPASS = FTP_PWD
PICPATH = "#{HOME}/screenshots/" # Include trailing slash or leave blank to save in working directory
NO_CLEAN = 1 # Remove the files locally afterwards or not
NO_THUMB = 0 # Make a thumbnail or not
DELAY = 0 # Screenshot delay in seconds

def usage
  puts "Usage: screenshot [name] <default name: current>
      -h, --help      - Display this"
  exit 1
end

def link
  puts "\nLink:\n\nhttp://#{FTPHOST}/gigamo/#{FTPPATH}/#{PICNAME}.png"
end

def printscreen
  if NO_THUMB == 0
    `scrot -d#{DELAY} #{PICPATH}#{PICNAME}.png && cp #{PICPATH}#{PICNAME}.png #{PICPATH}#{PICNAME}t.png && mogrify -resize 25% #{PICPATH}#{PICNAME}t.png`
  else
    `scrot -d#{DELAY} #{PICPATH}#{PICNAME}.png`
    puts "No thumbnail created. Either imagemagick is not installed on your system or NO_THUMB was set to 1"
  end
end

def upload
    if NO_THUMB == 0
      `ncftpput -u #{FTPUSER} -p #{FTPPASS} -R -m #{FTPHOST} #{FTPPATH} #{PICPATH}#{PICNAME}.png #{PICPATH}#{PICNAME}t.png`
    else
      `ncftpput -u #{FTPUSER} -p #{FTPPASS} -R -m #{FTPHOST} #{FTPPATH} #{PICPATH}#{PICNAME}.png`
    end
    puts "\nUpload succesful!"
end

def clean
  `rm -f #{PICPATH}#{PICNAME}.png #{PICPATH}#{PICNAME}t.png`
end

if ARGV[0] == "-h" or ARGV[0] == "--help"
  usage
else
  if ARGV.empty?
    PICNAME = "current"
  else
    PICNAME = ARGV[0]
  end
  if File.directory? "#{PICPATH}" and File.executable? "/usr/bin/scrot" and File.executable? "/usr/bin/ncftp" and File.executable? "/usr/bin/mogrify"
    printscreen
    upload
    link
    if NO_CLEAN == 0
      clean
    end
  else
    puts "Please make sure you have scrot, ncftp and imagemagick installed, and that #{PICPATH} is a directory"
    exit 1
  end
  exit 0
end
